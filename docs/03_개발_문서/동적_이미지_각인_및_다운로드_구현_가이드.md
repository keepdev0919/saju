# 기술 가이드: 동적 이미지 각인 및 클라이언트 다운로드 구현

## 1. 개요 (Overview)
유저가 결제를 완료하고 자신의 이름이 각인된 수호신 카드를 다운로드할 때, 백엔드와 프론트엔드가 어떻게 협력하여 파일을 생성하고 저장하는지에 대한 기술적 메커니즘을 설명합니다.

---

## 2. 전체 프로세스 (The Flow)

1. **요청 (Request)**: 프론트엔드에서 버튼 클릭 시 `수호신 ID`와 `유저 성함`을 서버 API로 전송.
2. **합성 (Baking)**: 서버가 원본 이미지 위에 유저 성함을 '그려 넣는' 작업 수행.
3. **전달 (Delivery)**: 합성된 이미지 데이터를 브라우저로 전송.
4. **저장 (Saving)**: 브라우저가 전송받은 데이터를 파일 형태로 유저 기기에 저장.

---

## 3. 하이브리드 전략 (Hybrid Strategy: Preview vs. Final)

프리미엄 사용자 경험을 위해 **실시간 미리보기**와 **고화질 저장**을 분리하여 운영합니다.

### A. 프론트엔드: 실시간 미리보기 (Preview)
- **기술**: `html2canvas` 
- **역할**: 유저가 자신의 성함(한자)을 입력하는 즉시, 카드 우측 하단 인장에 이름이 반영되는 것을 보여주어 **'소유욕'과 '즉각적인 보상'** 제공.
- **특징**: 브라우저 메모리 내에서만 작동하며, 결제 전 유저를 안심시키고 동기를 부여하는 '시각적 장치'임.

### B. 백엔드: 최종 고화질 다운로드 (Final Product)
- **기술**: `Node.js Sharp` (Server-side Baking)
- **역할**: 유저가 [저장하기] 버튼을 눌렀을 때, 서버에 숨겨진 **초고화질 원본 자산**에 이름을 정교하게 각인하여 전송.
- **특징**: 웹 화면 캡처의 한계(화질 저하, 폰트 깨짐)를 극복하고, 인쇄 가능한 수준의 **'진짜 부적'**을 제공하는 품질 보증 단계임.

---

4. 서버 측 구현 (Server-side: Node.js)

서버는 이미지 파일을 메모리에 올린 뒤, 캔버스(Canvas)처럼 글자를 그립니다.

```javascript
// Node.js (Express) 예시 코드
const sharp = require('sharp');

app.get('/api/download-talisman', async (req, res) => {
  const { type, name } = req.query; // 예: '갑자', '김철수'
  
  // 1. 원본 이미지 로드
  const original = await sharp(`./images/${type}.png`);
  
  // 2. 글자(이름) 레이어 생성 (SVG 활용)
  const textOverlay = Buffer.from(
    `<svg width="1024" height="1536">
      <text x="800" y="1400" font-family="Seoye" font-size="48" fill="#c2410c">${name}</text>
    </svg>`
  );

  // 3. 원본 + 글자 합성
  const processedImage = await original
    .composite([{ input: textOverlay, blend: 'over' }])
    .png()
    .toBuffer();

  // 4. 파일 다운로드 응답 설정
  res.setHeader('Content-Disposition', `attachment; filename="${name}_talisman.png"`);
  res.setHeader('Content-Type', 'image/png');
  res.send(processedImage);
});
```

---

## 4. 프론트엔드 구현 (Frontend: React)

서버가 보낸 이미지 바이너리(Blob)를 받아서 실제로 '다운로드'를 실행합니다.

```javascript
const handleDownload = async () => {
  const response = await fetch(`/api/download-talisman?type=갑자&name=김철수`);
  const blob = await response.blob(); // 이미지 데이터를 덩어리(Blob)로 받음
  
  // 브라우저 메모리에 임시 주소 생성
  const url = window.URL.createObjectURL(blob);
  
  // 가상의 '<a>' 태그를 만들어 클릭 시뮬레이션
  const link = document.createElement('a');
  link.href = url;
  link.download = "나의_수호신.png"; // 저장될 파일명
  document.body.appendChild(link);
  link.click();
  
  // 정리
  document.body.removeChild(link);
  window.URL.revokeObjectURL(url);
};
```

---

## 5. 핵심 기술 개념 (Key Concepts)

1. **Blob (Binary Large Object)**: 이미지, 비디오 같은 이진 데이터를 자바스크립트에서 다루는 객체입니다.
2. **Buffer**: 서버(Node.js)에서 바이너리 데이터를 처리하기 위한 임시 메모리 공간입니다.
3. **Sharp/Canvas**: 이미지를 합성하거나 픽셀 단위로 조작하는 엔진입니다.
4. **Content-Disposition**: 브라우저에게 "이 데이터는 화면에 보여주지 말고 파일로 저장해!"라고 명령하는 HTTP 헤더입니다.

---

## 6. 요약 제언
- **보안**: 프론트엔드에서 이미지를 만들면 유저가 코드를 조작해 다른 사람의 이름을 넣을 수 있습니다. 반드시 **서버(Node.js)**에서 합성하여 내려주는 것이 표준입니다.
- **성능**: 매번 다운로드할 때마다 합성하면 서버 부하가 생길 수 있으므로, 결제 직후 딱 한 번만 합성을 수행해 파일(S3/Firebase)로 저장해두고 주소만 주는 방식이 더 효율적입니다.
