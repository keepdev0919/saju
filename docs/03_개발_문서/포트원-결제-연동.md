# 💳 포트원(아임포트) 결제 연동 가이드

포트원 결제 시스템 연동 방법 및 테스트 가이드입니다.

## 📋 목차

1. [포트원 계정 설정](#포트원-계정-설정)
2. [환경 변수 설정](#환경-변수-설정)
3. [결제 플로우](#결제-플로우)
4. [테스트 방법](#테스트-방법)
5. [문제 해결](#문제-해결)

---

## 🔧 포트원 계정 설정

### 1. 포트원 대시보드 접속

1. [포트원 대시보드](https://admin.portone.io/) 접속
2. 회원가입 또는 로그인

### 2. 테스트 모드 설정

**테스트 모드 (개발용)**
- 사업자 등록 없이도 테스트 가능
- 가상의 결제로 테스트 가능
- 실제 결제는 발생하지 않음

**실제 모드 (운영용)**
- 사업자 등록증 필요
- 통신판매업 신고 필요
- 실제 결제 발생

### 3. V1 API 키 발급

1. 대시보드 → **연동 정보** → **식별코드 ㆍ API Keys**
2. **API 버전**에서 **V1 API** 선택
3. **고객사 식별코드** (IMP_KEY) 확인 및 복사
4. **REST API Secret** 확인 및 복사

---

## ⚙️ 환경 변수 설정

### 프론트엔드 (`.env`)

```env
VITE_PORTONE_IMP_KEY=imp12345678  # 포트원 가맹점 코드
```

### 백엔드 (`backend/.env`)

```env
PORTONE_IMP_KEY=imp12345678       # 포트원 V1 고객사 식별코드
PORTONE_IMP_SECRET=your_secret    # 포트원 V1 REST API Secret
```

**참고:**
- 프론트엔드와 백엔드 모두 V1 API를 사용합니다
- 포트원 대시보드에서 V1 API 키를 발급받아야 합니다

---

## 🔄 결제 플로우

### 1. 결제 요청 생성

**프론트엔드:**
```javascript
// 결제 요청 생성 (백엔드)
const paymentResponse = await createPayment({
  userId: userInfo.userId,
  amount: 9900,
  productType: 'basic'
});

const { merchantUid } = paymentResponse;
```

**백엔드:**
- `merchant_uid` 생성 (고유 주문번호)
- 결제 정보를 DB에 저장 (pending 상태)
- `merchant_uid` 반환

### 2. 포트원 결제 위젯 호출

**프론트엔드:**
```javascript
// 포트원 초기화
const IMP = window.IMP;
IMP.init(IMP_KEY);

// 결제 요청
IMP.request_pay({
  pg: 'kakaopay',              // PG사 선택
  pay_method: 'kakaopay',      // 결제 수단
  merchant_uid: merchantUid,   // 주문번호
  name: '2026 프리미엄 운세 리포트',
  amount: 9900,
  buyer_name: userInfo.name,
  buyer_tel: userInfo.phone
}, (rsp) => {
  if (rsp.success) {
    // 결제 성공
    const imp_uid = rsp.imp_uid;
    // 결제 검증 요청
  } else {
    // 결제 실패
    console.error(rsp.error_msg);
  }
});
```

### 3. 결제 검증

**프론트엔드:**
```javascript
// 결제 검증 요청 (백엔드)
const verifyResponse = await verifyPayment({
  imp_uid: rsp.imp_uid,
  merchant_uid: merchantUid
});
```

**백엔드:**
- 포트원 API로 결제 정보 조회
- 결제 금액 검증
- 결제 상태 업데이트 (paid)
- 카카오 알림톡 발송

### 4. 사주 계산 및 결과 표시

결제 검증 성공 후:
1. 사주 계산 API 호출
2. 결과 저장
3. 결과 페이지로 이동

---

## 🧪 테스트 방법

### 테스트 모드 사용

1. **포트원 대시보드**에서 테스트 모드 활성화
2. 환경 변수에 테스트용 가맹점 코드 설정

### 테스트 카드 정보

포트원 테스트 모드에서는 다음 카드 정보로 테스트 가능:

**신용카드:**
- 카드번호: `1234-5678-9012-3456`
- 유효기간: `12/34`
- CVC: `123`
- 비밀번호: `123456`

**카카오페이:**
- 테스트 모드에서 자동으로 테스트 결제 진행

### 테스트 시나리오

1. **정상 결제 테스트**
   - 결제 버튼 클릭
   - 테스트 카드 정보 입력
   - 결제 완료 확인
   - 사주 결과 페이지 이동 확인

2. **결제 실패 테스트**
   - 잘못된 카드 정보 입력
   - 결제 취소
   - 에러 메시지 확인

3. **결제 검증 테스트**
   - 결제 완료 후 백엔드 로그 확인
   - DB에 결제 정보 저장 확인
   - 알림톡 발송 확인

---

## 🐛 문제 해결

### 포트원 스크립트 로드 실패

**증상:**
```
결제 시스템을 불러오는 중입니다. 잠시 후 다시 시도해주세요.
```

**해결:**
1. `index.html`에 포트원 스크립트가 포함되어 있는지 확인
2. 네트워크 연결 확인
3. 브라우저 콘솔에서 에러 확인

### 결제 위젯이 열리지 않음

**증상:**
- 결제 버튼 클릭해도 아무 반응 없음

**해결:**
1. `VITE_PORTONE_IMP_KEY` 환경 변수 확인
2. 포트원 대시보드에서 가맹점 코드 확인
3. 브라우저 콘솔에서 에러 확인

### 결제 검증 실패

**증상:**
- 결제는 완료되었지만 검증 실패

**해결:**
1. 백엔드 로그 확인
2. `PORTONE_IMP_KEY`, `PORTONE_IMP_SECRET` 확인
3. 포트원 API 응답 확인
4. 결제 금액 일치 여부 확인

### 결제 완료 후 결과 페이지로 이동하지 않음

**증상:**
- 결제는 완료되었지만 결과 페이지로 이동하지 않음

**해결:**
1. 브라우저 콘솔에서 에러 확인
2. 네트워크 탭에서 API 호출 확인
3. `accessToken`이 정상적으로 받아지는지 확인

---

## 📚 참고 자료

- [포트원 공식 문서](https://developers.portone.io/)
- [포트원 대시보드](https://admin.portone.io/)
- [포트원 테스트 가이드](https://developers.portone.io/docs/ko/test)

---

## ✅ 체크리스트

결제 연동 완료 확인:

- [ ] 포트원 계정 생성 및 가맹점 코드 발급
- [ ] 환경 변수 설정 완료
- [ ] 포트원 스크립트 로드 확인
- [ ] 결제 위젯 정상 동작 확인
- [ ] 결제 검증 정상 동작 확인
- [ ] 테스트 결제 성공 확인
- [ ] 결제 완료 후 플로우 정상 동작 확인

